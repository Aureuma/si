name: CLI Release Assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Existing release tag to build/upload (for example v0.48.0)
        required: true
        type: string

concurrency:
  group: cli-release-assets-${{ github.event.release.tag_name || github.event.inputs.tag || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  attestations: write
  id-token: write

jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Resolve release tag
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.event.release.tag_name }}"
          if [[ -z "${tag}" ]]; then
            tag="${{ github.event.inputs.tag }}"
          fi
          if [[ -z "${tag}" ]]; then
            echo "No release tag provided." >&2
            exit 1
          fi
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "Building assets for tag: ${tag}"

  publish-assets:
    needs: [resolve-tag]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-tag.outputs.tag }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: tools/si/go.mod
          cache: true

      - name: Validate release tag and CLI version
        shell: bash
        run: |
          set -euo pipefail
          tools/release/validate-release-version.sh --tag "${{ needs.resolve-tag.outputs.tag }}"

      - name: Build all release archives and checksums
        shell: bash
        run: |
          set -euo pipefail
          tools/release/build-cli-release-assets.sh --version "${{ needs.resolve-tag.outputs.tag }}" --out-dir dist
          ls -lah dist

      - name: Upload assets to GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag="${{ needs.resolve-tag.outputs.tag }}"
          gh release view "${tag}" --repo "${{ github.repository }}" >/dev/null
          gh release upload "${tag}" dist/*.tar.gz dist/checksums.txt --repo "${{ github.repository }}" --clobber

      - name: Attest release artifacts
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            dist/*.tar.gz
            dist/checksums.txt

  publish-npm:
    name: Publish npm package (@aureuma/si-cli)
    needs: [resolve-tag, publish-assets]
    runs-on: ubuntu-latest
    steps:
      - name: Check npm publish secret
        id: gate
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${NPM_TOKEN}" ]]; then
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "NPM_TOKEN is not configured; skipping npm publish."
          else
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Checkout
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-tag.outputs.tag }}

      - name: Setup Node
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Publish @aureuma/si-cli
        if: steps.gate.outputs.enabled == 'true'
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          tools/release/npm/publish-npm-package.sh --version "${{ needs.resolve-tag.outputs.tag }}"

  update-homebrew-tap:
    name: Update homebrew-si tap formula
    needs: [resolve-tag, publish-assets]
    runs-on: ubuntu-latest
    steps:
      - name: Check Homebrew tap token
        id: gate
        shell: bash
        env:
          HOMEBREW_TAP_PUSH_TOKEN: ${{ secrets.HOMEBREW_TAP_PUSH_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${HOMEBREW_TAP_PUSH_TOKEN}" ]]; then
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "HOMEBREW_TAP_PUSH_TOKEN is not configured; skipping tap update."
          else
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Checkout
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/checkout@v4

      - name: Render and push tap formula update
        if: steps.gate.outputs.enabled == 'true'
        env:
          HOMEBREW_TAP_PUSH_TOKEN: ${{ secrets.HOMEBREW_TAP_PUSH_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ needs.resolve-tag.outputs.tag }}"
          checksums_url="https://github.com/${{ github.repository }}/releases/download/${tag}/checksums.txt"
          tmp_dir="$(mktemp -d)"
          trap 'rm -rf "${tmp_dir}"' EXIT

          curl --proto '=https' --tlsv1.2 -fsSL "${checksums_url}" -o "${tmp_dir}/checksums.txt"

          tap_dir="${tmp_dir}/homebrew-si"
          git clone "https://x-access-token:${HOMEBREW_TAP_PUSH_TOKEN}@github.com/Aureuma/homebrew-si.git" "${tap_dir}"
          git -C "${tap_dir}" config user.email "github-actions[bot]@users.noreply.github.com"
          git -C "${tap_dir}" config user.name "github-actions[bot]"

          tools/release/homebrew/update-tap-repo.sh \
            --version "${tag}" \
            --checksums "${tmp_dir}/checksums.txt" \
            --tap-dir "${tap_dir}" \
            --repo "${{ github.repository }}" \
            --commit \
            --push
