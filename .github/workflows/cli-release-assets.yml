name: CLI Release Assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Existing release tag to build/upload (for example v0.48.0)
        required: true
        type: string

concurrency:
  group: cli-release-assets-${{ github.event.release.tag_name || github.event.inputs.tag || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  attestations: write
  id-token: write

jobs:
  resolve-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Resolve release tag
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.event.release.tag_name }}"
          if [[ -z "${tag}" ]]; then
            tag="${{ github.event.inputs.tag }}"
          fi
          if [[ -z "${tag}" ]]; then
            echo "No release tag provided." >&2
            exit 1
          fi
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "Building assets for tag: ${tag}"

  publish-assets:
    needs: [resolve-tag]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-tag.outputs.tag }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: tools/si/go.mod
          cache: true

      - name: Validate release tag and CLI version
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ needs.resolve-tag.outputs.tag }}"
          if [[ -x "tools/release/validate-release-version.sh" ]]; then
            tools/release/validate-release-version.sh --tag "${tag}"
            exit 0
          fi

          if [[ ! -f "tools/si/version.go" ]]; then
            echo "tools/si/version.go not found for tag ${tag}" >&2
            exit 1
          fi

          actual="$(sed -n 's/^const siVersion = "\(.*\)"$/\1/p' tools/si/version.go)"
          if [[ -z "${actual}" ]]; then
            echo "unable to parse si version from tools/si/version.go" >&2
            exit 1
          fi

          if [[ "${actual}" != "${tag}" ]]; then
            echo "version mismatch: tools/si/version.go=${actual}, tag=${tag}" >&2
            exit 1
          fi

          echo "release tag and tools/si/version.go are aligned (${tag})"

      - name: Build all release archives and checksums
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ needs.resolve-tag.outputs.tag }}"
          if [[ -x "tools/release/build-cli-release-assets.sh" ]]; then
            tools/release/build-cli-release-assets.sh --version "${tag}" --out-dir dist
            ls -lah dist
            exit 0
          fi

          version_nov="${tag#v}"
          mkdir -p dist

          build_one() {
            local goos="$1"
            local goarch="$2"
            local goarm="${3:-}"
            local arch_label="$goarch"
            if [[ "${goarch}" == "arm" ]]; then
              arch_label="armv${goarm}"
            fi

            local stem="si_${version_nov}_${goos}_${arch_label}"
            local tmp_dir
            tmp_dir="$(mktemp -d)"
            local stage="${tmp_dir}/${stem}"
            mkdir -p "${stage}"

            local envs=("CGO_ENABLED=0" "GOOS=${goos}" "GOARCH=${goarch}")
            if [[ -n "${goarm}" ]]; then
              envs+=("GOARM=${goarm}")
            fi

            env "${envs[@]}" go build -trimpath -buildvcs=false -ldflags "-s -w" -o "${stage}/si" ./tools/si
            chmod 0755 "${stage}/si"
            [[ -f README.md ]] && cp README.md "${stage}/README.md"
            [[ -f LICENSE ]] && cp LICENSE "${stage}/LICENSE"

            tar -C "${tmp_dir}" -czf "dist/${stem}.tar.gz" "${stem}"
            rm -rf "${tmp_dir}"
          }

          build_one linux amd64
          build_one linux arm64
          build_one linux arm 7
          build_one darwin amd64
          build_one darwin arm64

          (
            cd dist
            : > checksums.txt
            for f in *.tar.gz; do
              sha256sum "${f}" >> checksums.txt
            done
          )
          ls -lah dist

      - name: Upload assets to GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag="${{ needs.resolve-tag.outputs.tag }}"
          gh release view "${tag}" --repo "${{ github.repository }}" >/dev/null
          gh release upload "${tag}" dist/*.tar.gz dist/checksums.txt --repo "${{ github.repository }}" --clobber

      - name: Attest release artifacts
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            dist/*.tar.gz
            dist/checksums.txt

  publish-npm:
    name: Publish npm package (@aureuma/si-cli)
    needs: [resolve-tag, publish-assets]
    runs-on: ubuntu-latest
    steps:
      - name: Check npm publish secret
        id: gate
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${NPM_TOKEN}" ]]; then
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "NPM_TOKEN is not configured; skipping npm publish."
          else
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Checkout
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/checkout@v4

      - name: Setup Node
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Publish @aureuma/si-cli
        if: steps.gate.outputs.enabled == 'true'
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ needs.resolve-tag.outputs.tag }}"
          if [[ -x "tools/release/npm/publish-npm-package.sh" ]]; then
            tools/release/npm/publish-npm-package.sh --version "${tag}"
            exit 0
          fi

          echo "tools/release/npm/publish-npm-package.sh is missing on this checkout; skipping npm publish for ${tag}."

  update-homebrew-tap:
    name: Update homebrew-si tap formula
    needs: [resolve-tag, publish-assets]
    runs-on: ubuntu-latest
    steps:
      - name: Check Homebrew tap token
        id: gate
        shell: bash
        env:
          HOMEBREW_TAP_PUSH_TOKEN: ${{ secrets.HOMEBREW_TAP_PUSH_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${HOMEBREW_TAP_PUSH_TOKEN}" ]]; then
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "HOMEBREW_TAP_PUSH_TOKEN is not configured; skipping tap update."
          else
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Checkout
        if: steps.gate.outputs.enabled == 'true'
        uses: actions/checkout@v4

      - name: Render and push tap formula update
        if: steps.gate.outputs.enabled == 'true'
        env:
          HOMEBREW_TAP_PUSH_TOKEN: ${{ secrets.HOMEBREW_TAP_PUSH_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ needs.resolve-tag.outputs.tag }}"
          checksums_url="https://github.com/${{ github.repository }}/releases/download/${tag}/checksums.txt"
          tmp_dir="$(mktemp -d)"
          trap 'rm -rf "${tmp_dir}"' EXIT

          curl --proto '=https' --tlsv1.2 -fsSL "${checksums_url}" -o "${tmp_dir}/checksums.txt"

          tap_dir="${tmp_dir}/homebrew-si"
          git clone "https://x-access-token:${HOMEBREW_TAP_PUSH_TOKEN}@github.com/Aureuma/homebrew-si.git" "${tap_dir}"
          git -C "${tap_dir}" config user.email "github-actions[bot]@users.noreply.github.com"
          git -C "${tap_dir}" config user.name "github-actions[bot]"

          tools/release/homebrew/update-tap-repo.sh \
            --version "${tag}" \
            --checksums "${tmp_dir}/checksums.txt" \
            --tap-dir "${tap_dir}" \
            --repo "${{ github.repository }}" \
            --commit \
            --push

  verify-release-distribution:
    name: Verify release assets, npm package, and Homebrew tap
    needs: [resolve-tag, publish-assets, publish-npm, update-homebrew-tap]
    runs-on: ubuntu-latest
    steps:
      - name: Verify release distribution state
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          HOMEBREW_TAP_PUSH_TOKEN: ${{ secrets.HOMEBREW_TAP_PUSH_TOKEN }}
        run: |
          set -euo pipefail

          tag="${{ needs.resolve-tag.outputs.tag }}"
          version="${tag#v}"
          if [[ -z "${version}" || "${version}" == "${tag}" ]]; then
            echo "invalid tag: ${tag}" >&2
            exit 1
          fi

          retry() {
            local attempts="$1"
            local delay="$2"
            shift 2
            local i
            for ((i=1; i<=attempts; i++)); do
              if "$@"; then
                return 0
              fi
              if (( i < attempts )); then
                sleep "${delay}"
              fi
            done
            return 1
          }

          assets="$(gh release view "${tag}" --repo "${{ github.repository }}" --json assets --jq '.assets[].name')"
          required_assets=(
            "si_${version}_linux_amd64.tar.gz"
            "si_${version}_linux_arm64.tar.gz"
            "si_${version}_linux_armv7.tar.gz"
            "si_${version}_darwin_amd64.tar.gz"
            "si_${version}_darwin_arm64.tar.gz"
            "checksums.txt"
          )
          for asset in "${required_assets[@]}"; do
            if ! grep -Fxq "${asset}" <<<"${assets}"; then
              echo "missing release asset: ${asset}" >&2
              exit 1
            fi
          done
          echo "release assets verified for ${tag}"

          if [[ -n "${NPM_TOKEN}" ]]; then
            if ! retry 12 10 npm view "@aureuma/si-cli@${version}" version >/dev/null 2>&1; then
              echo "npm package @aureuma/si-cli@${version} was not visible after retries" >&2
              exit 1
            fi
            npm_version="$(npm view "@aureuma/si-cli@${version}" version)"
            if [[ "${npm_version}" != "${version}" ]]; then
              echo "npm version mismatch: expected ${version}, got ${npm_version}" >&2
              exit 1
            fi
            echo "npm package verified: @aureuma/si-cli@${npm_version}"
          else
            echo "NPM_TOKEN is not configured; skipping npm verification."
          fi

          if [[ -n "${HOMEBREW_TAP_PUSH_TOKEN}" ]]; then
            tap_url="https://raw.githubusercontent.com/Aureuma/homebrew-si/main/Formula/si.rb"
            if ! retry 12 10 bash -lc "curl --proto '=https' --tlsv1.2 -fsSL '${tap_url}' | grep -Eq 'version\\s+\"${version}\"'"; then
              echo "Homebrew tap formula did not update to ${version} after retries" >&2
              exit 1
            fi
            echo "homebrew tap formula verified at version ${version}"
          else
            echo "HOMEBREW_TAP_PUSH_TOKEN is not configured; skipping tap verification."
          fi
