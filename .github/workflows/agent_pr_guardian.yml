name: Agent PR Guardian

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: agent-pr-guardian-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  guardian:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.draft == false

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Install shfmt
        run: |
          sudo apt-get update
          sudo apt-get install -y shfmt

      - name: Agent doctor
        run: bash tools/agents/doctor.sh

      - name: Run PR guardian
        id: guardian
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: bash tools/agents/pr-guardian.sh

      - name: Publish summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          summary_file="${{ steps.guardian.outputs.summary_file }}"
          if [[ -n "${summary_file}" && -f "${summary_file}" ]]; then
            cat "${summary_file}" >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Ensure labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: 'agent:triaged', color: '0E8A16', description: 'Triaged by automation agent' },
              { name: 'risk:low', color: '1D76DB', description: 'Low-risk change set' },
              { name: 'risk:medium', color: 'FBCA04', description: 'Medium-risk change set' },
              { name: 'risk:high', color: 'D93F0B', description: 'High-risk change set' }
            ];
            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
              } catch (err) {
                if (err.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ...label
                  });
                } else {
                  throw err;
                }
              }
            }

      - name: Label PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          RISK: ${{ steps.guardian.outputs.risk }}
        with:
          script: |
            const risk = process.env.RISK || 'low';
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['agent:triaged', `risk:${risk}`]
            });

      - name: Upsert PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          SUMMARY_FILE: ${{ steps.guardian.outputs.summary_file }}
        with:
          script: |
            const fs = require('node:fs');
            const marker = '<!-- agent:pr-guardian -->';
            const summaryPath = process.env.SUMMARY_FILE;
            const summary = fs.existsSync(summaryPath)
              ? fs.readFileSync(summaryPath, 'utf8')
              : 'No summary generated.';
            const body = `${marker}\n## PR Guardian Report\n\n${summary}`;
            const issue_number = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number
            });
            const previous = comments.find((c) => c.body && c.body.includes(marker));
            if (previous) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previous.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body
              });
            }

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-guardian-logs-${{ github.run_id }}
          path: .artifacts/agent-logs/pr-guardian/**
          if-no-files-found: ignore
