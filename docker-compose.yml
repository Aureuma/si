services:
  telegram-bot:
    build:
      context: ./agents/telegram-bot
    image: silexa/telegram-bot:local
    container_name: silexa-telegram-bot
    mem_limit: 128m
    cpus: "0.25"
    environment:
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - TELEGRAM_BOT_TOKEN_FILE=/run/secrets/telegram_bot_token
      - MANAGER_URL=http://manager:9090
    secrets:
      - telegram_bot_token
    restart: unless-stopped
    ports:
      - "8081:8081"

  resource-broker:
    build:
      context: ./agents/resource-broker
    image: silexa/resource-broker:local
    container_name: silexa-resource-broker
    mem_limit: 256m
    cpus: "0.5"
    environment:
      - TELEGRAM_NOTIFY_URL=http://telegram-bot:8081/notify
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - DATA_DIR=/data
    volumes:
      - ./data/resource-broker:/data
    ports:
      - "9091:9091"
    restart: unless-stopped

  infra-broker:
    build:
      context: ./agents/infra-broker
    image: silexa/infra-broker:local
    container_name: silexa-infra-broker
    mem_limit: 256m
    cpus: "0.5"
    environment:
      - TELEGRAM_NOTIFY_URL=http://telegram-bot:8081/notify
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - DATA_DIR=/data
    volumes:
      - ./data/infra-broker:/data
    ports:
      - "9092:9092"
    restart: unless-stopped

  manager:
    build:
      context: ./agents/manager
    image: silexa/manager:local
    container_name: silexa-manager
    mem_limit: 256m
    cpus: "0.5"
    environment:
      - TELEGRAM_NOTIFY_URL=http://telegram-bot:8081/notify
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - DATA_DIR=/data
    ports:
      - "9090:9090"
    restart: unless-stopped
    volumes:
      - ./data/manager:/data

  codex-monitor:
    build:
      context: ./agents/codex-monitor
    image: silexa/codex-monitor:local
    container_name: silexa-codex-monitor
    mem_limit: 256m
    cpus: "0.25"
    depends_on:
      - manager
    environment:
      - MANAGER_URL=http://manager:9090
      - CODEX_ACCOUNTS_FILE=/configs/codex_accounts.json
      - CODEX_STATUS_POLL_INTERVAL=2m
      - CODEX_COOLDOWN_THRESHOLD_PCT=10
      - CODEX_PLAN_LIMIT_MINUTES=300
      - CODEX_SPAWN_DYADS=1
      - CODEX_SPAWN_SCRIPT=/workspace/silexa/bin/spawn-dyad.sh
    volumes:
      - ./:/workspace/silexa
      - /var/run/docker.sock:/var/run/docker.sock
      - ./configs:/configs:ro
    restart: unless-stopped

  router:
    build:
      context: ./agents/router
    image: silexa/router:local
    container_name: silexa-router
    mem_limit: 128m
    cpus: "0.25"
    depends_on:
      - manager
    environment:
      - MANAGER_URL=http://manager:9090
      - ROUTER_RULES_FILE=/configs/router_rules.json
      - ROUTER_POLL_INTERVAL=10s
    volumes:
      - ./configs:/configs:ro
    restart: unless-stopped

  actor-pm:
    image: silexa/actor:local
    container_name: silexa-actor-pm
    mem_limit: 1g
    cpus: "1.0"
    working_dir: /workspace/apps
    volumes:
      - ./:/workspace/silexa
      - ./apps:/workspace/apps
      - codex_state_pm:/root/.codex
    environment:
      - ROLE=program_manager
      - DYAD_NAME=pm
      - DYAD_MEMBER=actor
      - DEPARTMENT=ops
      - CODEX_MODEL=gpt-5.1-codex-max
      - CODEX_REASONING_EFFORT=low
    tty: true
    restart: unless-stopped
    command: ["bash","-lc","npm i -g @openai/codex >/dev/null 2>&1 || true; /workspace/silexa/bin/codex-init.sh >/proc/1/fd/1 2>/proc/1/fd/2 || true; exec tail -f /dev/null"]

  critic-pm:
    image: silexa/critic:local
    container_name: silexa-critic-pm
    mem_limit: 512m
    cpus: "0.75"
    depends_on:
      - actor-pm
      - manager
    environment:
      - CRITIC_ID=silexa-critic-pm
      - ACTOR_CONTAINER=silexa-actor-pm
      - MANAGER_URL=http://manager:9090
      - DYAD_NAME=pm
      - DYAD_MEMBER=critic
      - ROLE=program_manager
      - DEPARTMENT=ops
      - PROGRAM_MANAGER=1
      - PROGRAM_CONFIG_DIR=/configs/programs/releaseparty
      - PM_MAX_NEW_PER_TICK=2
      - PM_MAX_OPEN_PER_DYAD=5
      - PM_MIN_OPEN_PER_DYAD=1
      - PM_MAX_OPEN_GLOBAL=25
      - TELEGRAM_NOTIFY_URL=http://telegram-bot:8081/notify
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - SSH_TARGET=${SSH_TARGET:-}
      - SSH_TARGET_FILE=/configs/ssh_target
      - CODEX_MODEL=gpt-5.1-codex-max
      - CODEX_REASONING_EFFORT=xhigh
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - codex_state_pm:/root/.codex
      - ./configs:/configs:ro
    user: "0:0"
    restart: unless-stopped

  coder-agent:
    build:
      context: ./agents/coder
    image: silexa/coder-agent:local
    container_name: silexa-coder-agent
    mem_limit: 2g
    cpus: "1.5"
    working_dir: /workspace/apps
    volumes:
      - ./apps:/workspace/apps
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsSL", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  actor-web:
    build:
      context: ./agents/actor
    image: silexa/actor:local
    container_name: silexa-actor-web
    mem_limit: 1g
    cpus: "1.0"
    working_dir: /workspace/apps
    volumes:
      - ./:/workspace/silexa
      - ./apps:/workspace/apps
      - /var/run/docker.sock:/var/run/docker.sock
      - codex_state_web:/root/.codex
    environment:
      - ROLE=webdev
      - DYAD_NAME=web
      - DYAD_MEMBER=actor
      - DEPARTMENT=web
      - CODEX_MODEL=gpt-5.1-codex-max
      - CODEX_REASONING_EFFORT=high
    tty: true
    restart: unless-stopped
    command: ["bash","-lc","npm i -g @openai/codex >/dev/null 2>&1 || true; /workspace/silexa/bin/codex-init.sh >/proc/1/fd/1 2>/proc/1/fd/2 || true; exec tail -f /dev/null"]

  critic-web:
    build:
      context: ./agents/critic
    image: silexa/critic:local
    container_name: silexa-critic-web
    mem_limit: 512m
    cpus: "0.75"
    depends_on:
      - actor-web
      - manager
    environment:
      - CRITIC_ID=silexa-critic-web
      - ACTOR_CONTAINER=silexa-actor-web
      - MANAGER_URL=http://manager:9090
      - DYAD_NAME=web
      - DYAD_MEMBER=critic
      - ROLE=critic
      - DEPARTMENT=web
      - TELEGRAM_NOTIFY_URL=http://telegram-bot:8081/notify
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - SSH_TARGET=${SSH_TARGET:-}
      - SSH_TARGET_FILE=/configs/ssh_target
      - CODEX_MODEL=gpt-5.1-codex-max
      - CODEX_REASONING_EFFORT=high
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - codex_state_web:/root/.codex
      - ./configs:/configs:ro
    user: "0:0"
    restart: unless-stopped

  actor-research:
    image: silexa/actor:local
    container_name: silexa-actor-research
    mem_limit: 1g
    cpus: "1.0"
    working_dir: /workspace/apps
    volumes:
      - ./:/workspace/silexa
      - ./apps:/workspace/apps
      - /var/run/docker.sock:/var/run/docker.sock
      - codex_state_research:/root/.codex
    environment:
      - ROLE=research
      - DYAD_NAME=research
      - DYAD_MEMBER=actor
      - DEPARTMENT=research
      - CODEX_MODEL=gpt-5.1-codex-max
      - CODEX_REASONING_EFFORT=xhigh
    tty: true
    restart: unless-stopped
    command: ["bash","-lc","npm i -g @openai/codex >/dev/null 2>&1 || true; /workspace/silexa/bin/codex-init.sh >/proc/1/fd/1 2>/proc/1/fd/2 || true; exec tail -f /dev/null"]

  critic-research:
    image: silexa/critic:local
    container_name: silexa-critic-research
    mem_limit: 512m
    cpus: "0.75"
    depends_on:
      - actor-research
      - manager
    environment:
      - CRITIC_ID=silexa-critic-research
      - ACTOR_CONTAINER=silexa-actor-research
      - MANAGER_URL=http://manager:9090
      - DYAD_NAME=research
      - DYAD_MEMBER=critic
      - ROLE=critic
      - DEPARTMENT=research
      - TELEGRAM_NOTIFY_URL=http://telegram-bot:8081/notify
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - SSH_TARGET=${SSH_TARGET:-}
      - SSH_TARGET_FILE=/configs/ssh_target
      - CODEX_MODEL=gpt-5.1-codex-max
      - CODEX_REASONING_EFFORT=high
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - codex_state_research:/root/.codex
      - ./configs:/configs:ro
    user: "0:0"
    restart: unless-stopped

  mcp-gateway:
    build:
      context: ./tools/mcp-gateway
    image: silexa/mcp-gateway:local
    container_name: silexa-mcp-gateway
    mem_limit: 512m
    cpus: "0.5"
    environment:
      - GH_TOKEN=${GH_TOKEN:-}
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
    ports:
      - "8088:8088"
    volumes:
      - ./data/mcp-gateway:/catalog
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  dashboard:
    build:
      context: ./agents/dashboard
    image: silexa/dashboard:local
    container_name: silexa-dashboard
    mem_limit: 256m
    cpus: "0.5"
    environment:
      - MANAGER_URL=http://manager:9090
      - BIN_DIR=/workspace/silexa/bin
      - ADDR=:8087
    working_dir: /workspace/silexa
    volumes:
      - ./:/workspace/silexa
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8087:8087"
    restart: unless-stopped

secrets:
  telegram_bot_token:
    file: ./secrets/telegram_bot_token

volumes:
  codex_state_web:
  codex_state_research:
  codex_state_pm:
