services:
  telegram-bot:
    build:
      context: ./agents/telegram-bot
    image: silexa/telegram-bot:local
    container_name: silexa-telegram-bot
    environment:
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - TELEGRAM_BOT_TOKEN_FILE=/run/secrets/telegram_bot_token
      - MANAGER_URL=http://manager:9090
    secrets:
      - telegram_bot_token
    restart: unless-stopped
    ports:
      - "8081:8081"

  manager:
    build:
      context: ./agents/manager
    image: silexa/manager:local
    container_name: silexa-manager
    environment:
      - TELEGRAM_NOTIFY_URL=http://telegram-bot:8081/notify
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - DATA_DIR=/data
    ports:
      - "9090:9090"
    restart: unless-stopped
    volumes:
      - ./data/manager:/data

  coder-agent:
    build:
      context: ./agents/coder
    image: silexa/coder-agent:local
    container_name: silexa-coder-agent
    working_dir: /workspace/apps
    volumes:
      - ./apps:/workspace/apps
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsSL", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  actor-web:
    build:
      context: ./agents/actor
    image: silexa/actor:local
    container_name: silexa-actor-web
    working_dir: /workspace/apps
    volumes:
      - ./apps:/workspace/apps
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - ROLE=webdev
    tty: true
    restart: unless-stopped

  critic-web:
    build:
      context: ./agents/critic
    image: silexa/critic:local
    container_name: silexa-critic-web
    depends_on:
      - actor-web
      - manager
    environment:
      - ACTOR_CONTAINER=silexa-actor-web
      - MANAGER_URL=http://manager:9090
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    user: "0:0"
    restart: unless-stopped

  actor-research:
    image: silexa/actor:local
    container_name: silexa-actor-research
    working_dir: /workspace/apps
    volumes:
      - ./apps:/workspace/apps
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - ROLE=research
    tty: true
    restart: unless-stopped

  critic-research:
    image: silexa/critic:local
    container_name: silexa-critic-research
    depends_on:
      - actor-research
      - manager
    environment:
      - ACTOR_CONTAINER=silexa-actor-research
      - MANAGER_URL=http://manager:9090
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    user: "0:0"
    restart: unless-stopped

secrets:
  telegram_bot_token:
    file: ./secrets/telegram_bot_token
