apiVersion: v1
kind: Service
metadata:
  name: silexa-codex-monitor
  labels:
    app: silexa-codex-monitor
    silexa.component: codex-monitor
spec:
  selector:
    app: silexa-codex-monitor
  ports:
    - name: http
      port: 8086
      targetPort: 8086
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: silexa-codex-monitor
  labels:
    app: silexa-codex-monitor
    silexa.component: codex-monitor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: silexa-codex-monitor
  template:
    metadata:
      labels:
        app: silexa-codex-monitor
        silexa.component: codex-monitor
    spec:
      serviceAccountName: silexa-core
      containers:
        - name: codex-monitor
          image: silexa/codex-monitor:local
          ports:
            - containerPort: 8086
          env:
            - name: MANAGER_URL
              value: http://silexa-manager:9090
            - name: CODEX_ACCOUNTS_FILE
              value: /configs/codex_accounts.json
            - name: CODEX_STATUS_POLL_INTERVAL
              value: 2m
            - name: CODEX_COOLDOWN_THRESHOLD_PCT
              value: "10"
            - name: CODEX_PLAN_LIMIT_MINUTES
              value: "300"
            - name: CODEX_SPAWN_DYADS
              value: "1"
            - name: CODEX_MONITOR_ADDR
              value: ":8086"
            - name: SILEXA_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          volumeMounts:
            - name: configs
              mountPath: /configs
              readOnly: true
      volumes:
        - name: configs
          configMap:
            name: silexa-configs
            items:
              - key: codex_accounts.json
                path: codex_accounts.json
